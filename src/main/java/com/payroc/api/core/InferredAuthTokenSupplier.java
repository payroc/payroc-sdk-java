/**
 * This file was auto-generated by Fern from our API Definition.
 */
package com.payroc.api.core;

import com.payroc.api.resources.auth.AuthClient;
import com.payroc.api.resources.auth.requests.RetrieveTokenAuthRequest;
import com.payroc.api.resources.auth.types.GetTokenResponse;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Supplier;

public final class InferredAuthTokenSupplier implements Supplier<Map<String, String>> {
    private static final long BUFFER_IN_MINUTES = 2;

    private final String apiKey;

    private final AuthClient authClient;

    private Map<String, String> cachedHeaders;

    private Instant expiresAt;

    public InferredAuthTokenSupplier(String apiKey, AuthClient authClient) {
        this.apiKey = apiKey;
        this.authClient = authClient;
        this.expiresAt = Instant.now();
    }

    private GetTokenResponse fetchToken() {
        RetrieveTokenAuthRequest getTokenRequest =
                RetrieveTokenAuthRequest.builder().apiKey(apiKey).build();
        return authClient.retrieveToken(getTokenRequest);
    }

    @java.lang.Override
    public Map<String, String> get() {
        if (cachedHeaders == null || expiresAt.isBefore(Instant.now())) {
            GetTokenResponse tokenResponse = fetchToken();
            Map<String, String> headers = new HashMap<>();
            headers.put("Authorization", "Bearer " + tokenResponse.getAccessToken());
            this.cachedHeaders = headers;
            this.expiresAt = getExpiresAt(tokenResponse.getExpiresIn());
        }
        return cachedHeaders;
    }

    private Instant getExpiresAt(long expiresInSeconds) {
        return Instant.now().plus(expiresInSeconds, ChronoUnit.SECONDS).minus(BUFFER_IN_MINUTES, ChronoUnit.MINUTES);
    }
}
